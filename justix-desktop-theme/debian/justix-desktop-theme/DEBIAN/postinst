#!/bin/sh
# postinst script for sample-package
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see https://www.debian.org/doc/debian-policy/ or
# the debian-policy package

# Diverted files
ORIG_FILE="/usr/lib/ubuntu-mate/ubuntu-mate-settings-overlay"
MY_FILE="/usr/lib/ubuntu-mate/justix-mate-settings-overlay"
MY_PACKAGE="justix-desktop-theme"

case "$1" in
    configure)

    # Afegim les diversions de fitxers
    if dpkg-divert --package ${MY_PACKAGE} --add  --rename  --divert ${ORIG_FILE}.real ${ORIG_FILE} ; then
	    ln -fs ${MY_FILE} ${ORIG_FILE}
	else
	    echo "Unabe to divert file ${ORIG_FILE}"
	fi 



    # Eliminem tota la configuració prèvia dels usuaris actuals
    
    for usr in `ls /home`; do
      #echo -n "/home/$usr/.config/dconf/user"
      if [ -f "/home/$usr/.config/dconf/user" ]; then
        [ -f "/home/$usr/.config/dconf/user.backup" ] && rm "/home/$usr/.config/dconf/user.backup"
        mv "/home/$usr/.config/dconf/user" "/home/$usr/.config/dconf/user.backup"
        echo "\e[1m\e[93m [Justix] \e[95m Moved  /home/$usr/.config/dconf/user to /home/$usr/.config/dconf/user.backup\e[0m";
      fi      
      
      if [ -d "/home/$usr/.config/plank" -a -f "home/$usr/.config/plank/dock1/launchers/vlc-1.dockitem" ]; then
      
        [ -d "/home/$usr/.config/plank.backup" ] && rm -r "/home/$usr/.config/plank.backup"
        mv "/home/$usr/.config/plank" "/home/$usr/.config/plank.backup"
        echo "\e[1m\e[93m [Justix] \e[95m Moved  /home/$usr/.config/plank to /home/$usr/.config/plank.backup\e[0m";
      fi 
      
      if [ -f "/home/$usr/.config/ubuntu-mate/welcome/preferences.json" ]; then
        [ -f "/home/$usr/.config/ubuntu-mate/welcome/preferences.json.backup" ] && rm /home/$usr/.config/ubuntu-mate/welcome/preferences.json.backup
        mv "/home/$usr/.config/ubuntu-mate/welcome/preferences.json" "/home/$usr/.config/ubuntu-mate/welcome/preferences.json.backup"
        echo "\e[1m\e[93m [Justix] \e[95m Moved  /home/$usr/.config/ubuntu-mate/welcome/preferences.json to /home/$usr/.config/ubuntu-mate/welcome/preferences.json.backup.$TIMESTAMP\e[0m";
      fi
        

	    # Eliminant l'autoarranc de l'ubuntu-mate-welcome

        [ -d "/home/$usr/.config/ubuntu-mate/welcome" ] || mkdir -p "/home/$usr/.config/ubuntu-mate/welcome"
        cp -r "/etc/skel/.config/ubuntu-mate/welcome/preferences.json" "/home/$usr/.config/ubuntu-mate/welcome/preferences.json"


    if [ -f "/etc/xdg/autostart/ubuntu-mate-welcome-autostart.desktop" ]; then
        [ -f "/etc/xdg/autostart/ubuntu-mate-welcome-autostart.desktop.justix_moved" ] && rm "/etc/xdg/autostart/ubuntu-mate-welcome-autostart.desktop.justix_moved"
        mv "/etc/xdg/autostart/ubuntu-mate-welcome-autostart.desktop" "/etc/xdg/autostart/ubuntu-mate-welcome-autostart.desktop.justix_moved"
    fi
    done

    #dconf update

    #[ -x /usr/bin/update-gconf-defaults ]  &&  /usr/bin/update-gconf-defaults
    
    # Update panel layout for current user
    mate-panel --replace --reset || echo "\e[1m\e[93m [Justix] \e[38;5;208m  S'ha produït un error ressetejant mate-panel. Es continúa l'execució. \e[0m"

    if update-gconf-defaults > /dev/null; then 
      update-gconf-defaults || echo "\e[1m\e[93m [Justix] \e[38;5;208m  S'ha produït un error actualitzant gconf. Es continúa l'execució. \e[0m"
    fi

    update-alternatives \
		--install /usr/share/backgrounds/justix-default-background.png justix-default-background.png \
		/usr/share/backgrounds/justix/desktop.png 500


	update-icon-caches /usr/share/icons/hicolor/scalable/ || true 
        gtk-update-icon-cache /usr/share/icons/hicolor || true


    # Update plymouth
    update-alternatives --install /usr/share/plymouth/themes/default.plymouth default.plymouth /usr/share/plymouth/themes/justix/justix.plymouth 180
    update-alternatives --install /usr/share/plymouth/themes/text.plymouth text.plymouth /usr/share/plymouth/themes/justix-text/justix-text.plymouth 180

  	#update-alternatives --config default.plymouth
  	update-initramfs -u

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

# Automatically added by dh_icons/12.1.1ubuntu1+p18.04+git20190517.0034
if [ "$1" = "configure" ] || [ "$1" = "abort-upgrade" ] || [ "$1" = "abort-deconfigure" ] || [ "$1" = "abort-remove" ] ; then
	if which update-icon-caches >/dev/null 2>&1 ; then
		update-icon-caches /usr/share/icons/justix
	fi
fi
# End automatically added section


exit 0
